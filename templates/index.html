<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate File Converter</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link href="/static/style.css" rel="stylesheet">
</head>
<body class="py-16">
    <div class="container mx-auto px-4">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
                Ultimate File Converter
            </h1>
            <p class="text-gray-400">Convert files between formats instantly</p>
        </div>

        <div id="drop-area" class="rounded-xl p-8 mb-8">
            <div class="space-y-4">
                <div class="text-2xl">üìÅ Drag & Drop files here</div>
                <div class="text-gray-400">or</div>
                <label class="btn-primary inline-block cursor-pointer">
                    <input type="file" id="file-input" class="hidden" multiple>
                    Browse Files
                </label>
            </div>
        </div>

        <div id="file-info" class="hidden bg-gray-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Selected File</h2>
            <div id="file-details" class="mb-6"></div>
            
            <div class="mb-6">
                <label class="block mb-2 font-medium">Output Format</label>
                <select id="format-select" class="w-full bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"></select>
            </div>

            <button id="convert-btn" class="btn-primary w-full flex items-center justify-center gap-2">
                <span>Convert Now</span>
                <div id="spinner" class="hidden loading-spinner"></div>
            </button>
        </div>

        <div id="result" class="hidden converted-file bg-gray-800 rounded-xl p-6 text-center">
            <h2 class="text-xl font-semibold mb-4">üéâ Conversion Complete!</h2>
            <a id="download-link" class="btn-primary inline-block px-8">
                Download File
            </a>
        </div>

        <div id="error" class="hidden bg-red-500/20 rounded-xl p-4 text-red-300 mb-8"></div>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area')
        const fileInput = document.getElementById('file-input')
        const convertBtn = document.getElementById('convert-btn')
        const spinner = document.getElementById('spinner')

        // Drag & drop handlers
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault()
            dropArea.classList.add('dragover')
        })

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover')
        })

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault()
            dropArea.classList.remove('dragover')
            handleFiles(e.dataTransfer.files)
        })

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files))

        async function handleFiles(files) {
            if (!files.length) return
            const file = files[0]
            
            document.getElementById('file-info').classList.remove('hidden')
            document.getElementById('error').classList.add('hidden')
            document.getElementById('file-details').innerHTML = `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="font-medium">${file.name}</div>
                    <div class="text-gray-400 text-sm">${(file.size/1024/1024).toFixed(2)} MB</div>
                </div>
            `

            try {
                const response = await fetch(`/options/${file.name}`)
                if (!response.ok) throw new Error('Failed to get formats')
                const { formats } = await response.json()
                
                const select = document.getElementById('format-select')
                select.innerHTML = formats.map(format => 
                    `<option value="${format}">${format.toUpperCase()}</option>`
                ).join('')
            } catch (error) {
                showError(error.message)
            }
        }

        convertBtn.addEventListener('click', async () => {
            const file = fileInput.files[0]
            if (!file) return
            
            convertBtn.disabled = true
            spinner.classList.remove('hidden')
            document.getElementById('error').classList.add('hidden')

            try {
                // Upload file
                const formData = new FormData()
                formData.append('file', file)
                const uploadRes = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                if (!uploadRes.ok) throw new Error('Upload failed')
                const { filename } = await uploadRes.json()

                // Convert file
                const outputFormat = document.getElementById('format-select').value
                const convertRes = await fetch('/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, output_format: outputFormat })
                })
                if (!convertRes.ok) throw new Error('Conversion failed')
                const { converted_filename } = await convertRes.json()

                // Show result
                document.getElementById('download-link').href = `/download/${converted_filename}`
                document.getElementById('result').classList.remove('hidden')
            } catch (error) {
                showError(error.message)
            } finally {
                convertBtn.disabled = false
                spinner.classList.add('hidden')
            }
        })

        function showError(message) {
            const errorDiv = document.getElementById('error')
            errorDiv.textContent = `Error: ${message}`
            errorDiv.classList.remove('hidden')
        }
    </script>
</body>
</html>